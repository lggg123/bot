on: [push]

name: Genymotion - GramAddict Bot Runner

jobs:
  run-bot:
    name: Start Genymotion Device and Run GramAddict
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9" # IMPORTANT: GramAddict README says Python 3.10+ is not supported.

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Start Genymotion Cloud SaaS instance
        id: genymotion
        uses: genymobile/genymotion-saas-github-action@v1
        with:
          api_token: ${{ secrets.API_KEY }}
          recipe_uuid: ea5fda48-fa8b-48c1-8acc-07d910856141 # Google Pixel XL 8.1

      - name: Install and Run GramAddict
        env:
          IG_USERNAME: ${{ secrets.IG_USERNAME }}
        run: |
          # Step 1: Install GramAddict via pip
          echo "Installing GramAddict..."
          python -m pip install --upgrade pip
          pip install GramAddict

          # Step 2: Initialize uiautomator2 on the device
          echo "Initializing uiautomator2..."
          uiautomator2 init

          # Step 3: Connect to the Genymotion device via ADB
          echo "Connecting to device with serial: ${{ steps.genymotion.outputs.device_serial }}"
          adb connect ${{ steps.genymotion.outputs.device_serial }}
          echo "Verifying connected devices..."
          adb devices

          # Step 4: Run the bot using the pre-committed config file
          echo "Starting GramAddict for user $IG_USERNAME..."
          gramaddict run --config accounts/$IG_USERNAME/config.yml
