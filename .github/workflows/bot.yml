on: [push]

name: Genymotion - GramAddict Bot Runner

jobs:
  run-bot:
    name: Start Genymotion Device and Run GramAddict
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Start Genymotion Cloud SaaS instance
        id: genymotion
        uses: genymobile/genymotion-saas-github-action@v1
        with:
          api_token: ${{ secrets.API_KEY }}
          recipe_uuid: ea5fda48-fa8b-48c1-8acc-07d910856141 # Google Pixel XL 8.1

      - name: Install and Run GramAddict
        env:
          IG_USERNAME: ${{ secrets.IG_USERNAME }}
          IG_PASSWORD: ${{ secrets.IG_PASSWORD }}
        run: |
          # Step 1: Install GramAddict via pip
          echo "Installing GramAddict..."
          python -m pip install --upgrade pip
          pip install GramAddict ruamel.yaml

          # Step 2: Initialize uiautomator2 (this also confirms connection)
          echo "Initializing uiautomator2..."
          uiautomator2 init

          # Step 3: Get the device serial dynamically (for verification)
          echo "Finding device serial..."
          DEVICE_SERIAL=$(adb devices | awk 'NR==2 {print $1}')
          
          if [ -z "$DEVICE_SERIAL" ]; then
            echo "::error::Could not find attached device serial from 'adb devices'. Aborting."
            exit 1
          fi
          echo "Found device serial: $DEVICE_SERIAL. GramAddict will find this automatically."

          # Step 4: Inject password into config file preserving format
          echo "Injecting password into config..."
          python3 << 'PYTHON_SCRIPT'
          from ruamel.yaml import YAML
          import os
          import sys

          yaml = YAML()
          yaml.preserve_quotes = True
          yaml.width = 4096  # Prevent line wrapping
          
          config_path = f"accounts/{os.environ['IG_USERNAME']}/config.yml"

          try:
              # Read the config file preserving format
              with open(config_path, 'r') as f:
                  config = yaml.load(f)
              
              # Update only the password field
              config['password'] = os.environ['IG_PASSWORD']
              
              # Write back preserving all formatting
              with open(config_path, 'w') as f:
                  yaml.dump(config, f)
              
              print(f"✅ Successfully updated password in {config_path}")
              print(f"   Username: {config.get('username')}")
              print(f"   Password set: {'Yes' if config.get('password') else 'No'}")
              print(f"   Feed setting: {config.get('feed')}")
          except Exception as e:
              print(f"❌ Error updating config: {e}", file=sys.stderr)
              sys.exit(1)
          PYTHON_SCRIPT

          # Step 5: Run the bot using the pre-committed config file
          echo "Starting GramAddict for user $IG_USERNAME..."
          gramaddict run --config accounts/$IG_USERNAME/config.yml
